name: Publish to NuGet

on:
  push:
    branches: [ main ]

permissions:
  contents: write

jobs:

  # ===============================
  # 1) Windows: Build only
  # ===============================
  build_windows:
    runs-on: windows-latest

    outputs:
      version: ${{ steps.get_version.outputs.version }}
      projects: ${{ steps.find_projects.outputs.projects }}

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x

    - name: Find csproj
      id: find_projects
      shell: bash
      run: |
        PROJECTS=$(find src -maxdepth 1 -name "*.csproj")
        echo "projects<<EOF" >> $GITHUB_OUTPUT
        echo "$PROJECTS" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Get version
      id: get_version
      shell: bash
      run: |
        MAX_VERSION="0.0.0"
        for PROJ in ${{ steps.find_projects.outputs.projects }}; do
          VER=$(sed -n 's|.*<Version>\(.*\)</Version>.*|\1|p' "$PROJ")
          if [ -n "$VER" ]; then
            printf '%s\n%s\n' "$MAX_VERSION" "$VER" | sort -V | tail -n1 > tmp.txt
            MAX_VERSION=$(cat tmp.txt)
          fi
        done
        echo "version=$MAX_VERSION" >> $GITHUB_OUTPUT

    - name: Build
      shell: bash
      run: |
        for PROJ in ${{ steps.find_projects.outputs.projects }}; do
          dotnet build "$PROJ" -c Release
        done

    - name: Upload build output
      uses: actions/upload-artifact@v4
      with:
        name: build-output
        path: src/**/bin/Release/**/*


  # ===============================
  # 2) Ubuntu: Pack & Publish
  # ===============================
  pack_publish:
    runs-on: ubuntu-latest
    needs: build_windows

    steps:
    - uses: actions/checkout@v4

    - name: Restore version
      run: echo "VERSION=${{ needs.build_windows.outputs.version }}" >> $GITHUB_ENV

    - name: Download build output
      uses: actions/download-artifact@v4
      with:
        name: build-output
        path: build

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x
        source-url: https://api.nuget.org/v3/index.json
      env:
        NUGET_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Check version
      id: check_version
      shell: bash
      run: |
        LATEST=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
        CURRENT="v${{ env.VERSION }}"
        if [ "$LATEST" != "$CURRENT" ]; then
          echo "is_new=true" >> $GITHUB_OUTPUT
        else
          echo "is_new=false" >> $GITHUB_OUTPUT
        fi

    - name: Pack (--no-build)
      if: steps.check_version.outputs.is_new == 'true'
      shell: bash
      run: |
        mkdir -p artifacts
        for PROJ in ${{ needs.build_windows.outputs.projects }}; do
          dotnet pack "$PROJ" --no-build -c Release -o ./artifacts
        done

    - name: Tag
      if: steps.check_version.outputs.is_new == 'true'
      shell: bash
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git tag "v${{ env.VERSION }}"
        git push origin "v${{ env.VERSION }}"

    - name: Release
      if: steps.check_version.outputs.is_new == 'true'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: "v${{ env.VERSION }}"
        files: artifacts/*.nupkg

    - name: NuGet Push
      if: steps.check_version.outputs.is_new == 'true'
      shell: bash
      run: |
        dotnet nuget push artifacts/*.nupkg \
          --api-key ${{ secrets.NUGET_API_KEY }} \
          --source https://api.nuget.org/v3/index.json \
          --skip-duplicate