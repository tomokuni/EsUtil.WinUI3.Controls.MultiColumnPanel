name: Publish

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  # --------------------------------------------------
  # 1. Setup & Detection
  # --------------------------------------------------
  setup:
    runs-on: ubuntu-latest
    outputs:
      project: ${{ steps.det.outputs.project }}
      id: ${{ steps.det.outputs.id }}
      runner: ${{ steps.det.outputs.runner }}
      version: ${{ steps.det.outputs.version }}
    steps:
      - uses: actions/checkout@v4
      - id: det
        shell: pwsh
        run: |
          # プロジェクトの網羅的探索
          $projs = Get-ChildItem -Recurse -Filter "*.csproj" | Where-Object { $_.FullName -notmatch "Sample|Test|obj|bin" }
          if (!$projs) { throw "No projects found." }

          # パッケージ化対象の特定を試みる
          $p = $projs | Where-Object { (Get-Content $_.FullName -Raw) -match "<PackageId>|<GeneratePackageOnBuild>True" } | Select-Object -First 1
          if (!$p) { $p = $projs | Select-Object -First 1 }

          # OSの判定 (WinUI, WPF, WinForms, or windows TFM)
          $content = Get-Content $p.FullName -Raw
          $isWin = $content -match "<UseWinUI>true</UseWinUI>|<UseWPF>true</UseWPF>|<UseWindowsForms>true</UseWindowsForms>|-windows"
          $run = if ($isWin) { "windows-latest" } else { "ubuntu-latest" }

          # 属性取得
          [xml]$xml = Get-Content $p.FullName
          $v = $xml.Project.PropertyGroup.Version
          if ([string]::IsNullOrWhiteSpace($v)) { $v = "1.0.0" }
          $id = $xml.Project.PropertyGroup.PackageId
          if ([string]::IsNullOrWhiteSpace($id)) { $id = $xml.Project.PropertyGroup.AssemblyName }
          if ([string]::IsNullOrWhiteSpace($id)) { $id = $p.BaseName }

          # 相対パスの算出
          $rel = $p.FullName.Replace($PWD.Path, "").TrimStart("\").TrimStart("/")

          Write-Host "Detected Project: $rel"
          Write-Host "Detected Runner: $run"

          # 出力のセット
          "project=$rel" | Add-Content $env:GITHUB_OUTPUT
          "id=$id" | Add-Content $env:GITHUB_OUTPUT
          "runner=$run" | Add-Content $env:GITHUB_OUTPUT
          "version=$v" | Add-Content $env:GITHUB_OUTPUT

  # --------------------------------------------------
  # 2. Build & Sync (Project Meta & Badges)
  # --------------------------------------------------
  build:
    needs: setup
    runs-on: ${{ needs.setup.outputs.runner }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: |
            8.0.x
            10.0.x

      - name: Sync Meta & Badges
        id: sync
        shell: pwsh
        run: |
          $p = "${{ needs.setup.outputs.project }}"
          [xml]$xml = Get-Content $p

          # Version 同期 (タグ push 時、csproj をタグ名に合わせる)
          if ("${{ github.ref_type }}" -eq "tag") {
            $tagV = "${{ github.ref_name }}".TrimStart('v')
            if ($xml.Project.PropertyGroup.Version) {
              if ($xml.Project.PropertyGroup.Version -ne $tagV) {
                $xml.Project.PropertyGroup.Version = $tagV
                $xml.Save($p)
              }
            } else {
              $vNode = $xml.CreateElement("Version")
              $vNode.InnerText = $tagV
              $xml.Project.PropertyGroup[0].AppendChild($vNode)
              $xml.Save($p)
            }
          }

          # README バッジの自動更新
          if (Test-Path "README.md") {
            $readme = Get-Content "README.md" -Raw
            $repo = "${{ github.repository }}"
            $pkg = "${{ needs.setup.outputs.id }}"
            $buildB = "[![Build](https://github.com/$repo/actions/workflows/publish.yml/badge.svg)](https://github.com/$repo/actions/workflows/publish.yml)"
            $nugetB = "[![NuGet](https://img.shields.io/nuget/v/$pkg.svg)](https://www.nuget.org/packages/$pkg/)"

            if ($readme -notmatch "\[!\[Build\]") { $readme = "$buildB`n$readme" }
            if ($readme -match "\[!\[NuGet\]") { $readme = $readme -replace "\[!\[NuGet\].*?\)", $nugetB }
            elseif ($readme -match "\[!\[Build\]") { $readme = $readme -replace "(\[!\[Build\].*?\))", "`$1 $nugetB" }
            Set-Content "README.md" $readme -NoNewline
          }

          # 変更があれば自動コミット (タグ push 時の変化またはメインブランチでのバッジ更新)
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          if (!(git diff --quiet --staged)) {
            git commit -m "chore: update version/badges [skip ci]"
            # メインブランチに直接プッシュ
            git push origin HEAD:${{ github.event.repository.default_branch }}
          }

      - name: Build & Test
        shell: pwsh
        run: |
          dotnet build "${{ needs.setup.outputs.project }}" -c Release
          # テストプロジェクトがあれば実行
          Get-ChildItem -Recurse -Filter "*[Tt]est*.csproj" | Where-Object { $_.FullName -notmatch "obj|bin" } | ForEach-Object {
            dotnet test $_.FullName -c Release
          }

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-assets
          path: |
            **/bin/Release/**
            **/obj/Release/**
          if-no-files-found: error

  # --------------------------------------------------
  # 3. Publish (NuGet & GitHub Release) - Tags Only
  # --------------------------------------------------
  publish:
    needs: [setup, build]
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: |
            8.0.x
            10.0.x

      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-assets

      - name: Pack (--no-build)
        run: dotnet pack "${{ needs.setup.outputs.project }}" -c Release --no-build -o dist

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: dist/*.nupkg
          generate_release_notes: true
          prerelease: ${{ contains(github.ref_name, '-') }}

      - name: Push to NuGet
        run: dotnet nuget push dist/*.nupkg --api-key ${{ secrets.NUGET_API_KEY }} --source https://api.nuget.org/v3/index.json --skip-duplicate
